<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Home | MetacriticScraper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Filter the games according to their Metascore, User Score and Release Date">
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/stack-interface.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/socicon.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/lightbox.min.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/flickity.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/iconsmind.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/jquery.steps.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/custom.css" rel="stylesheet" type="text/css" media="all" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:200,300,400,400i,500,600,700%7CMerriweather:300,300i" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <section class="cover height-50 imagebg text-center parallax" data-overlay="4">
            <div class="container pos-vertical-center">
                <div class="row">
                    <div class="col-md-8 col-lg-7">
                        <h1>
                            Filter the games according to their Metascore, User Score and Release Date
                        </h1>
                    </div>
                </div>
            </div>
        </section>
        <section>
            <div class="container">
                <form class="row">
                    <div class="col-md-6">
                        <div class="col-md-2 input-radio">
                            <span class="input__label">PC</span>
                            <input id="platform1" name="platform" type="radio" value="0" checked />
                            <label for="radio-1"></label>
                        </div>
                        <div class="col-md-2 input-radio">
                            <span class="input__label">PS4</span>
                            <input id="platform2" name="platform" type="radio" value="1" />
                            <label for="radio-1"></label>
                        </div>
                        <div class="col-md-2 input-radio">
                            <span class="input__label">XBox One</span>
                            <input id="platform3" name="platform" type="radio" value="2" />
                            <label for="radio-1"></label>
                        </div>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <label for="metascore">Minimum Metascore (Between 0 to 100):</label>
                        <input type="range" id="metascore" name="metascore" placeholder="Minimum Metascore (Between 0 to 100)" min="0" max="100"
                               oninput="document.getElementById('metascore-label').innerHTML = this.value;" />
                        <em id="metascore-label" style="font-style: normal;"></em>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <label for="userscore">Minimum User Score (Between 0 to 10):</label>
                        <input type="range" id="userscore" name="userscore" placeholder="Minimum User Score (Between 0 to 10)" min="0" max="10" step="0.1"
                               oninput="document.getElementById('userscore-label').innerHTML = this.value;" />
                        <em id="userscore-label" style="font-style: normal;"></em>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <label for="releasedate">Minimum Release Date:</label>
                        <input type="text" id="releasedate" name="releasedate" class="datepicker" placeholder="Minimum Release Date" />
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <a id="filter-btn" class="btn btn--primary" onclick="filterGames();">
                            <span class="btn__text">Filter Games</span>
                        </a>
                    </div>
                </form>
                <br />
                <table id="games" class="border--round table--alternate-row" style="display: none">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Platform</th>
                            <th>MetaScore</th>
                            <th>UserScore</th>
                            <th>ReleaseDate</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <footer class="text-center space--sm footer-5 bg--dark">
            <div class="container">
            </div>
        </footer>
    </div>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/flickity.min.js"></script>
    <script src="js/easypiechart.min.js"></script>
    <script src="js/parallax.js"></script>
    <script src="js/typed.min.js"></script>
    <script src="js/datepicker.js"></script>
    <script src="js/isotope.min.js"></script>
    <script src="js/ytplayer.min.js"></script>
    <script src="js/lightbox.min.js"></script>
    <script src="js/granim.min.js"></script>
    <script src="js/jquery.steps.min.js"></script>
    <script src="js/countdown.min.js"></script>
    <script src="js/spectragram.min.js"></script>
    <script src="js/smooth-scroll.min.js"></script>
    <script src="js/scripts.js"></script>
</body>
</html>

<script>
    window.onload = function () {
        document.getElementById('metascore-label').innerHTML = document.getElementById('metascore').value;
        document.getElementById('userscore-label').innerHTML = document.getElementById('userscore').value;
    }

    function filterGames() {
        beforeFilter();
        $
            .getJSON(getRequestUrl(), function (result) {
                if (result.length == 0) {
                    appendRow(getEmptyRowHtml(this));
                }
                $.each(result, function () {
                    appendRow(getRowHtml(this));
                });
            })
            .always(function () {
                afterFilter();
            });
    }

    function beforeFilter() {
        platformText = $('input[name="platform"]:checked').siblings('.input__label').text()
        $('#games').hide();
        $('#games tbody').html('');
        $('#filter-btn').addClass('disabled');
        $('#filter-btn span').text('Loading...');
    }

    function afterFilter() {
        $('#games').show();
        $('#filter-btn').removeClass('disabled');
        $('#filter-btn span').text('Filter Games');
    }

    function getEmptyRowHtml() {
        return "<tr><td colspan='5'>No games with those filters</td></tr>";
    }

    function getRowHtml(data) {
        return "<tr><td><a target='_blank' href='" + data.url + "'>" + data.name + "</a></td>" +
            "<td>" + platformText + "</td>" +
            "<td>" + (data.metaScore != null ? data.metaScore : 'TBD') + "</td>" +
            "<td>" + (data.userScore != null ? data.userScore : 'TBD') + "</td>" +
            "<td>" + new Date(data.releaseDate).toLocaleDateString("en-US") + "</td></tr>"
    }

    function getRequestUrl() {
        var params = {
            Platform: $('input[name="platform"]:checked').val(),
            MinMetaScore: $('#metascore').val(),
            MinUserScore: $('#userscore').val(),
            MinReleaseDate: $('#releasedate').val(),
        };
        var queryString = encodeQueryData(params);
        return "https://localhost:44380/api/Metacritic?" + queryString;
    }

    function appendRow(tr) {
        $('#games tbody').append(tr);
    }

    function encodeQueryData(data) {
        var ret = [];
        for (var key in data) {
            if (data[key]) {
                ret.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
            }
        }

        return ret.join('&');
    }
</script>